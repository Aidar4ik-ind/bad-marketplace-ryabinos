<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ИИ-ассистент - BADDvisor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { padding-top: 80px; font-family: 'Inter', sans-serif; }
        .ai-header { 
            background: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%);
            color: white; 
            padding: 80px 0;
            position: relative;
            overflow: hidden;
        }
        .ai-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 70% 30%, rgba(255,255,255,0.1) 0%, transparent 50%);
        }
        .ai-avatar {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #4cc9f0 0%, #4895ef 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            font-size: 3rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--gray-500);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        .symptom-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .history-item {
            background: white;
            border-radius: var(--border-radius-md);
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border: 1px solid var(--gray-200);
            cursor: pointer;
            transition: all 0.3s;
        }
        .history-item:hover {
            border-color: var(--primary-color);
            background: rgba(67, 97, 238, 0.05);
        }
        .confidence-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .confidence-high { background: rgba(76, 201, 240, 0.2); color: #4cc9f0; }
        .confidence-medium { background: rgba(248, 150, 30, 0.2); color: #f8961e; }
        .confidence-low { background: rgba(230, 57, 70, 0.2); color: #e63946; }
    </style>
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">
                <i class="bi bi-capsule me-2 gradient-text"></i>BADDvisor
            </a>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Главная</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="catalog.html">Каталог</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="assistant.html">ИИ-ассистент</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link position-relative" href="cart.html">
                            <i class="bi bi-cart3"></i> Корзина
                            <span id="cartCounter" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Шапка ИИ -->
    <div class="ai-header">
        <div class="container position-relative z-1">
            <div class="row align-items-center">
                <div class="col-lg-6">
                    <h1 class="display-4 fw-bold mb-4">ИИ-ассистент BADDvisor</h1>
                    <p class="lead mb-4">Опишите ваше состояние, и искусственный интеллект подберет оптимальные БАДы на основе анализа 100+ симптомов</p>
                    <div class="d-flex align-items-center">
                        <div class="ai-avatar me-4">
                            <i class="bi bi-robot"></i>
                        </div>
                        <div>
                            <h5 class="text-white mb-1">AI Assistant v2.0</h5>
                            <small class="text-white opacity-75">Улучшенный алгоритм анализа с расширенной базой знаний</small>
                            <div class="mt-2">
                                <span class="badge bg-white text-primary me-2">30+ БАДов</span>
                                <span class="badge bg-white text-primary me-2">100+ симптомов</span>
                                <span class="badge bg-white text-primary">Умный анализ</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 text-center mt-4 mt-lg-0">
                    <div class="bg-white rounded-3 p-4 d-inline-block shadow-lg">
                        <div class="ai-avatar mb-3">
                            <i class="bi bi-cpu"></i>
                        </div>
                        <h5>Как работает ИИ?</h5>
                        <p class="text-muted mb-0">
                            <small>
                                1. Анализ ключевых слов<br>
                                2. Определение групп симптомов<br>
                                3. Подбор оптимальной комбинации БАДов<br>
                                4. Учет взаимодействия компонентов
                            </small>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Основной контент -->
    <div class="container py-5">
        <div class="row">
            <div class="col-lg-4">
                <!-- История запросов -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-clock-history text-primary me-2"></i>История консультаций
                        </h5>
                        <div id="chatHistory">
                            <div class="history-item" onclick="loadFromHistory('Проблемы со сном и стресс')">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="small">Проблемы со сном и стресс</div>
                                    <span class="badge bg-primary">4 БАДа</span>
                                </div>
                                <div class="text-muted extra-small mt-1">Сегодня, 10:30</div>
                            </div>
                            <div class="history-item" onclick="loadFromHistory('Усталость и нет энергии')">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="small">Усталость и нет энергии</div>
                                    <span class="badge bg-primary">3 БАДа</span>
                                </div>
                                <div class="text-muted extra-small mt-1">Вчера, 15:45</div>
                            </div>
                            <div class="history-item" onclick="loadFromHistory('Частые простуды, иммунитет')">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="small">Частые простуды, иммунитет</div>
                                    <span class="badge bg-primary">5 БАДов</span>
                                </div>
                                <div class="text-muted extra-small mt-1">2 дня назад</div>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary w-100 mt-3" onclick="clearHistory()">
                            <i class="bi bi-trash me-1"></i>Очистить историю
                        </button>
                    </div>
                </div>

                <!-- Быстрые симптомы -->
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title mb-3">
                            <i class="bi bi-lightning-charge text-primary me-2"></i>Быстрый выбор симптомов
                        </h5>
                        <div class="symptom-grid" id="symptomsContainer">
                            <div class="symptom-chip" data-group="sleep">
                                <i class="bi bi-moon me-2"></i>Проблемы со сном
                            </div>
                            <div class="symptom-chip" data-group="stress">
                                <i class="bi bi-emoji-dizzy me-2"></i>Стресс и тревога
                            </div>
                            <div class="symptom-chip" data-group="energy">
                                <i class="bi bi-lightning-charge me-2"></i>Усталость и слабость
                            </div>
                            <div class="symptom-chip" data-group="immunity">
                                <i class="bi bi-shield-check me-2"></i>Частые простуды
                            </div>
                            <div class="symptom-chip" data-group="digestion">
                                <i class="bi bi-stomach me-2"></i>Пищеварение
                            </div>
                            <div class="symptom-chip" data-group="joints">
                                <i class="bi bi-heart-pulse me-2"></i>Суставы и боли
                            </div>
                            <div class="symptom-chip" data-group="brain">
                                <i class="bi bi-cpu me-2"></i>Концентрация
                            </div>
                            <div class="symptom-chip" data-group="mood">
                                <i class="bi bi-emoji-smile me-2"></i>Настроение
                            </div>
                            <div class="symptom-chip" data-group="detox">
                                <i class="bi bi-recycle me-2"></i>Очищение организма
                            </div>
                        </div>
                        
                        <div class="mt-4">
                            <h6 class="mb-3">Комплексные проблемы:</h6>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="setComplexQuery('стресс и сон')">
                                    Стресс + Сон
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="setComplexQuery('энергия и иммунитет')">
                                    Энергия + Иммунитет
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="setComplexQuery('суставы и воспаление')">
                                    Суставы + Воспаление
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <!-- Чат с ИИ -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-chat-dots text-primary me-2"></i>Чат с ИИ-ассистентом
                            </h5>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-secondary" onclick="clearChat()">
                                    <i class="bi bi-trash"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="exportChat()">
                                    <i class="bi bi-download"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="chat-container mb-3" id="chatWindow">
                            <div class="message ai-message">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0 me-2">
                                        <i class="bi bi-robot text-primary"></i>
                                    </div>
                                    <div>
                                        <strong>ИИ-ассистент:</strong>
                                        <div class="mt-1">
                                            Здравствуйте! Я ИИ-ассистент BADDvisor. Я помогу подобрать оптимальные БАДы для вашего состояния.
                                        </div>
                                        <div class="mt-2">
                                            <strong>Как это работает:</strong>
                                            <ul class="small mb-0 mt-1">
                                                <li>Опишите ваши симптомы (например: "плохо сплю и чувствую усталость")</li>
                                                <li>Или выберите симптомы из списка слева</li>
                                                <li>Или используйте примеры запросов ниже</li>
                                            </ul>
                                        </div>
                                        <div class="mt-2">
                                            <span class="badge bg-primary">Совет:</span>
                                            <span class="small">Чем подробнее вы опишете симптомы, тем точнее будут рекомендации</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="input-group">
                            <textarea class="form-control" 
                                      id="aiInput" 
                                      rows="2" 
                                      placeholder="Опишите ваше состояние... Например: 'Плохо сплю по ночам, просыпаюсь уставшим, днем нет энергии, часто нервничаю на работе...'"></textarea>
                            <button class="btn btn-primary" id="sendButton">
                                <i class="bi bi-send"></i> Отправить
                            </button>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <div class="form-text">
                                Нажмите Enter для отправки, Shift+Enter для новой строки
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="startVoiceInput()">
                                    <i class="bi bi-mic"></i> Голосовой ввод
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Результаты -->
                <div class="card border-0 shadow-sm" id="resultsCard" style="display: none;">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-star text-warning me-2"></i>Рекомендации ИИ-ассистента
                            </h5>
                            <div>
                                <span class="badge bg-success" id="confidenceBadge">Высокая точность</span>
                            </div>
                        </div>
                        
                        <div id="aiExplanation" class="alert alert-info mb-4">
                            <!-- Объяснение ИИ -->
                        </div>
                        
                        <!-- Анализ запроса -->
                        <div class="card border mb-4">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="bi bi-clipboard-data text-primary me-2"></i>Анализ вашего запроса
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>Определенные проблемы:</strong></p>
                                        <div id="detectedProblems">
                                            <!-- Проблемы будут добавлены через JS -->
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>Ключевые слова:</strong></p>
                                        <div id="detectedKeywords" class="d-flex flex-wrap gap-1">
                                            <!-- Ключевые слова будут добавлены через JS -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-warning mb-4">
                            <div class="d-flex">
                                <i class="bi bi-exclamation-triangle fs-4 me-3"></i>
                                <div>
                                    <h6 class="alert-heading mb-2">Важная информация</h6>
                                    <p class="mb-0 small">
                                        <strong>Это демонстрационная система.</strong> Рекомендации носят информационный характер и не заменяют консультацию врача. Перед применением БАДов проконсультируйтесь со специалистом.
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <h6 class="mb-3">Рекомендованные БАДы:</h6>
                        <div class="row" id="recommendedProducts">
                            <!-- Рекомендованные продукты -->
                        </div>
                        
                        <!-- Сводка -->
                        <div class="card border mt-4">
                            <div class="card-body">
                                <h6 class="card-title mb-3">
                                    <i class="bi bi-receipt text-primary me-2"></i>Сводка рекомендаций
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>Всего рекомендовано:</strong> <span id="totalRecommended">0</span> БАДов</p>
                                        <p class="mb-2"><strong>Общая стоимость:</strong> <span id="totalPrice">0</span> ₽</p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="mb-2"><strong>Рекомендуемый курс:</strong> 1-3 месяца</p>
                                        <p class="mb-0"><strong>Ожидаемый эффект:</strong> через 2-4 недели</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button class="btn btn-success btn-lg" id="addAllBtn" style="display: none;">
                                <i class="bi bi-cart-check me-2"></i>Добавить все в корзину
                            </button>
                            <button class="btn btn-outline-primary ms-2" onclick="saveRecommendation()">
                                <i class="bi bi-bookmark me-2"></i>Сохранить рекомендации
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Примеры запросов -->
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-body">
                        <h6 class="card-title mb-3">
                            <i class="bi bi-chat-square-quote text-primary me-2"></i>Примеры запросов для тестирования
                        </h6>
                        <div class="row">
                            <div class="col-md-3 col-6 mb-2">
                                <button class="btn btn-sm btn-outline-secondary w-100" onclick="setExample('Плохо сплю уже неделю, просыпаюсь ночью')">
                                    <i class="bi bi-moon me-1"></i>Сон
                                </button>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <button class="btn btn-sm btn-outline-secondary w-100" onclick="setExample('Постоянный стресс на работе, не могу расслабиться')">
                                    <i class="bi bi-emoji-dizzy me-1"></i>Стресс
                                </button>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <button class="btn btn-sm btn-outline-secondary w-100" onclick="setExample('Нет энергии целый день, чувствую слабость')">
                                    <i class="bi bi-lightning-charge me-1"></i>Энергия
                                </button>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <button class="btn btn-sm btn-outline-secondary w-100" onclick="setExample('Часто болею простудой, иммунитет слабый')">
                                    <i class="bi bi-shield-check me-1"></i>Иммунитет
                                </button>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <button class="btn btn-sm btn-outline-secondary w-100" onclick="setExample('Болят суставы, особенно колени и спина')">
                                    <i class="bi bi-heart-pulse me-1"></i>Суставы
                                </button>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <button class="btn btn-sm btn-outline-secondary w-100" onclick="setExample('Плохая память, сложно концентрироваться')">
                                    <i class="bi bi-cpu me-1"></i>Память
                                </button>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <button class="btn btn-sm btn-outline-secondary w-100" onclick="setExample('Часто болит живот, проблемы с пищеварением')">
                                    <i class="bi bi-stomach me-1"></i>Пищеварение
                                </button>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <button class="btn btn-sm btn-outline-secondary w-100" onclick="setExample('Плохое настроение, ничего не радует')">
                                    <i class="bi bi-emoji-smile me-1"></i>Настроение
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Футер -->
    <footer class="bg-dark text-white py-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h5 class="fw-bold mb-4">
                        <i class="bi bi-robot me-2"></i>ИИ-ассистент BADDvisor
                    </h5>
                    <p class="text-muted">
                        Умная система подбора БАДов на основе искусственного интеллекта.<br>
                        Демонстрационная версия с улучшенными алгоритмами анализа.
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">
                        <small>© 2024 BADDvisor. Демонстрационный проект. Все данные вымышлены.</small>
                    </p>
                    <p class="mb-0 mt-2">
                        <small>Не является медицинской рекомендацией. Перед применением БАДов проконсультируйтесь с врачом.</small>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Скрипты -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/products.js"></script>
    <script src="js/cart.js"></script>
    <script src="js/ai-rules.js"></script>
    <script>
        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            updateCartCounter();
            initAIAssistant();
            loadChatHistory();
        });

        function initAIAssistant() {
            // Обработчики для чипов симптомов
            document.querySelectorAll('.symptom-chip').forEach(chip => {
                chip.addEventListener('click', function() {
                    const group = this.getAttribute('data-group');
                    const groupData = symptomGroups[group];
                    
                    if (!groupData) return;
                    
                    // Добавляем в чат
                    const message = `Выбрал: ${groupData.name}`;
                    addMessage(message, 'user');
                    
                    // Обрабатываем запрос
                    setTimeout(() => {
                        processGroupRequest(group);
                    }, 500);
                });
            });

            // Кнопка отправки
            document.getElementById('sendButton').addEventListener('click', sendMessage);
            
            // Обработка Enter
            document.getElementById('aiInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
        }

        function sendMessage() {
            const input = document.getElementById('aiInput').value.trim();
            if (!input) return;
            
            addMessage(input, 'user');
            document.getElementById('aiInput').value = '';
            
            // Сохраняем в историю
            saveToHistory(input);
            
            // Показываем индикатор загрузки
            const loadingMsg = addMessage(`
                <div class="typing-indicator">
                    <span>ИИ анализирует ваш запрос</span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                    <span class="typing-dot"></span>
                </div>
            `, 'ai');
            
            // Имитация задержки для реалистичности
            setTimeout(() => {
                // Удаляем индикатор
                loadingMsg.remove();
                
                // Обрабатываем запрос
                processAIRequest(input);
            }, 1500);
        }

        function addMessage(text, sender = 'ai') {
            const chatWindow = document.getElementById('chatWindow');
            const messageDiv = document.createElement('div');
            
            messageDiv.className = `message ${sender}-message animate-fadeInUp`;
            
            if (sender === 'user') {
                messageDiv.innerHTML = `
                    <div class="d-flex align-items-start">
                        <div class="flex-shrink-0 me-2">
                            <i class="bi bi-person-circle text-primary"></i>
                        </div>
                        <div>
                            <strong>Вы:</strong>
                            <div class="mt-1">${text}</div>
                        </div>
                    </div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="d-flex align-items-start">
                        <div class="flex-shrink-0 me-2">
                            <i class="bi bi-robot text-primary"></i>
                        </div>
                        <div>
                            <strong>ИИ-ассистент:</strong>
                            <div class="mt-1">${text}</div>
                        </div>
                    </div>
                `;
            }
            
            chatWindow.appendChild(messageDiv);
            chatWindow.scrollTop = chatWindow.scrollHeight;
            
            return messageDiv;
        }

        function processAIRequest(input) {
            const analysis = analyzeAIRequest(input);
            const products = Products.getAll();
            
            // Получаем рекомендованные продукты
            const recommended = analysis.productIds
                .map(id => products.find(p => p.id === id))
                .filter(Boolean)
                .slice(0, 8); // Максимум 8 рекомендаций
            
            // Генерируем объяснение
            const explanation = generateExplanation(
                analysis.keywords, 
                analysis.matchedGroups, 
                recommended
            );
            
            // Определяем уровень уверенности
            const confidence = calculateConfidence(analysis.keywords.length, analysis.matchedGroups.length);
            
            // Показываем результат
            showRecommendations(recommended, explanation, analysis, confidence);
            
            // Добавляем ответ ИИ в чат
            addMessage(explanation, 'ai');
        }

        function processGroupRequest(groupKey) {
            const group = symptomGroups[groupKey];
            if (!group) return;
            
            const products = Products.getByIds(group.products);
            const explanation = `Вы выбрали: <strong>${group.name}</strong>. ${group.description}. Вот рекомендованные БАДы:`;
            
            const analysis = {
                keywords: group.keywords.slice(0, 3),
                matchedGroups: [group.name],
                productIds: group.products
            };
            
            const confidence = calculateConfidence(analysis.keywords.length, 1);
            
            showRecommendations(products, explanation, analysis, confidence);
            addMessage(explanation, 'ai');
        }

        function calculateConfidence(keywordsCount, groupsCount) {
            const score = keywordsCount * 10 + groupsCount * 30;
            
            if (score >= 60) return { level: 'high', text: 'Высокая точность', class: 'confidence-high' };
            if (score >= 30) return { level: 'medium', text: 'Средняя точность', class: 'confidence-medium' };
            return { level: 'low', text: 'Низкая точность', class: 'confidence-low' };
        }

        function showRecommendations(products, explanation, analysis, confidence) {
            // Показываем карточку результатов
            const resultsCard = document.getElementById('resultsCard');
            resultsCard.style.display = 'block';
            
            // Прокручиваем к результатам
            setTimeout(() => {
                resultsCard.scrollIntoView({ behavior: 'smooth' });
            }, 100);
            
            // Устанавливаем объяснение
            document.getElementById('aiExplanation').innerHTML = explanation;
            
            // Устанавливаем бейдж уверенности
            const confidenceBadge = document.getElementById('confidenceBadge');
            confidenceBadge.textContent = confidence.text;
            confidenceBadge.className = `badge ${confidence.class}`;
            
            // Показываем определенные проблемы
            const problemsContainer = document.getElementById('detectedProblems');
            if (analysis.matchedGroups.length > 0) {
                problemsContainer.innerHTML = analysis.matchedGroups.map(group => 
                    `<span class="badge bg-primary me-1 mb-1">${group}</span>`
                ).join('');
            } else {
                problemsContainer.innerHTML = '<span class="text-muted">Не удалось определить конкретные проблемы</span>';
            }
            
            // Показываем ключевые слова
            const keywordsContainer = document.getElementById('detectedKeywords');
            if (analysis.keywords.length > 0) {
                keywordsContainer.innerHTML = analysis.keywords.map(keyword => 
                    `<span class="badge bg-secondary">${keyword}</span>`
                ).join('');
            } else {
                keywordsContainer.innerHTML = '<span class="text-muted">Ключевые слова не найдены</span>';
            }
            
            // Рендерим продукты
            const container = document.getElementById('recommendedProducts');
            container.innerHTML = products.map(product => `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="product-card h-100">
                        <img src="${product.image}" 
                             class="card-img-top" 
                             alt="${product.name}"
                             style="height: 150px; object-fit: cover;"
                             onerror="this.src='data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 300 200\"><rect width=\"300\" height=\"200\" fill=\"%23f8f9fa\"/><text x=\"150\" y=\"100\" font-family=\"Arial\" font-size=\"16\" text-anchor=\"middle\" fill=\"%236c757d\">Нет изображения</text></svg>'">
                        <div class="p-3">
                            <h6 class="card-title">${product.name}</h6>
                            <p class="card-text text-muted small mb-2">${product.description}</p>
                            <div class="mb-2">
                                ${product.tags.slice(0, 2).map(tag => 
                                    `<span class="badge-tag">${tag}</span>`
                                ).join('')}
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-bold">${product.price} ₽</span>
                                <button class="btn btn-sm btn-primary" onclick="addToCart(${product.id})">
                                    В корзину
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Обновляем сводку
            const totalPrice = products.reduce((sum, product) => sum + product.price, 0);
            document.getElementById('totalRecommended').textContent = products.length;
            document.getElementById('totalPrice').textContent = totalPrice;
            
            // Кнопка "Добавить все"
            const addAllBtn = document.getElementById('addAllBtn');
            if (products.length > 1) {
                addAllBtn.style.display = 'inline-block';
                addAllBtn.onclick = function() {
                    products.forEach(p => addToCart(p.id));
                    if (window.cart && window.cart.showNotification) {
                        cart.showNotification(`Добавлено ${products.length} товаров в корзину!`, 'success');
                    }
                };
            } else {
                addAllBtn.style.display = 'none';
            }
        }

        function setExample(text) {
            document.getElementById('aiInput').value = text;
            document.getElementById('aiInput').focus();
        }

        function setComplexQuery(text) {
            document.getElementById('aiInput').value = text;
            sendMessage();
        }

        function addToCart(productId) {
            if (window.addToCart) {
                window.addToCart(productId, 1, event);
                updateCartCounter();
            }
        }

        function updateCartCounter() {
            if (window.cart && cart.updateCounter) {
                cart.updateCounter();
            }
        }

        // История чата
        function saveToHistory(query) {
            const history = JSON.parse(localStorage.getItem('ai_chat_history') || '[]');
            history.unshift({
                query: query,
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleString()
            });
            
            // Ограничиваем историю 10 последними запросами
            if (history.length > 10) {
                history.pop();
            }
            
            localStorage.setItem('ai_chat_history', JSON.stringify(history));
            loadChatHistory();
        }

        function loadChatHistory() {
            const history = JSON.parse(localStorage.getItem('ai_chat_history') || '[]');
            const container = document.getElementById('chatHistory');
            
            if (!container) return;
            
            if (history.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="bi bi-clock-history fs-4 d-block mb-2"></i>
                        <small>История запросов пуста</small>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = history.map((item, index) => `
                <div class="history-item" onclick="loadFromHistory('${item.query.replace(/'/g, "\\'")}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="small text-truncate">${item.query}</div>
                        <span class="badge bg-primary">${index + 1}</span>
                    </div>
                    <div class="text-muted extra-small mt-1">${item.date}</div>
                </div>
            `).join('');
        }

        function loadFromHistory(query) {
            document.getElementById('aiInput').value = query;
            sendMessage();
        }

        function clearHistory() {
            if (confirm('Очистить всю историю запросов?')) {
                localStorage.removeItem('ai_chat_history');
                loadChatHistory();
                
                if (window.cart && window.cart.showNotification) {
                    cart.showNotification('История очищена', 'info');
                }
            }
        }

        function clearChat() {
            if (confirm('Очистить всю переписку с ИИ?')) {
                document.getElementById('chatWindow').innerHTML = `
                    <div class="message ai-message">
                        <div class="d-flex align-items-start">
                            <div class="flex-shrink-0 me-2">
                                <i class="bi bi-robot text-primary"></i>
                            </div>
                            <div>
                                <strong>ИИ-ассистент:</strong>
                                <div class="mt-1">
                                    Чат очищен. Я готов помочь вам с подбором БАДов!
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function exportChat() {
            const messages = Array.from(document.querySelectorAll('#chatWindow .message'))
                .map(msg => {
                    const isUser = msg.classList.contains('user-message');
                    const text = msg.textContent.trim();
                    return `${isUser ? 'Вы' : 'ИИ'}: ${text}`;
                })
                .join('\n\n');
            
            const blob = new Blob([messages], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `baddvisor_chat_${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function saveRecommendation() {
            const resultsCard = document.getElementById('resultsCard');
            if (resultsCard.style.display === 'none') {
                if (window.cart && window.cart.showNotification) {
                    cart.showNotification('Сначала получите рекомендации от ИИ', 'warning');
                }
                return;
            }
            
            const explanation = document.getElementById('aiExplanation').textContent;
            const products = Array.from(document.querySelectorAll('#recommendedProducts .product-card'))
                .map(card => card.querySelector('.card-title').textContent)
                .join(', ');
            
            const recommendation = {
                date: new Date().toLocaleString(),
                explanation: explanation,
                products: products,
                total: document.getElementById('totalRecommended').textContent + ' БАДов'
            };
            
            localStorage.setItem('last_recommendation', JSON.stringify(recommendation));
            
            if (window.cart && window.cart.showNotification) {
                cart.showNotification('Рекомендации сохранены!', 'success');
            }
        }

        // Голосовой ввод (демо-режим)
        function startVoiceInput() {
            if (window.cart && window.cart.showNotification) {
                cart.showNotification('Голосовой ввод доступен в полной версии', 'info');
            }
        }
    </script>
</body>
</html>